# Simulation Reporting & Analytics Plan

## Current State Assessment

### ✅ Already Implemented (Strong Foundation)

#### Directory Structure & Isolation
- Each simulation creates a timestamped output directory
- All inputs, logs, and outputs saved in one location
- Clean separation: `initialization/`, `cp_sat/`, `logs/`, `reports/`

#### Input Data Capture
- Initialization files copied to each simulation folder
- Customer and plant information stored
- Treatment programs, stations, transporters preserved

#### Logging & Diagnostics
- `simulation_log.csv`: Timestamped events (STEP, INIT, ERROR)
- `movement_diagnostics.csv`: Per-task phase breakdown, timing validation
- `transporter_phases.csv`: Phase time distribution per transporter

#### Outputs Generated
- `cp_sat_batch_schedule.csv`: Phase 1 batch assignments
- `cp_sat_hoist_schedule.csv`: Phase 2 transporter movements
- `cp_sat_station_schedule.csv`: Station occupancy timeline
- Treatment programs (original + optimized versions)

#### Current PDF Report
Generated by `generate_simulation_report.py`:
- Cover page with customer/plant info and timestamp
- First page Gantt chart visualization
- Descriptive text about the simulation
- Stations table with transporter assignments
- Treatment programs summary
- Pie chart of transporter phase distribution

#### Visualizations
- Timeline/Gantt charts (10 pages of matrix visualizations)
- Transporter phase breakdown (pie chart)
- Schedule Gantt from Phase 1

---

## Gap Analysis: Missing Features

### 1. Executive Summary Section
**Status:** ❌ Not implemented

**Missing metrics:**
- Total makespan (simulation end time)
- Number of batches processed
- Solver status (FEASIBLE/OPTIMAL) and solve time
- Objective value and optimization gap
- Total simulation runtime
- Component count (if decomposition used)

### 2. Performance Analytics
**Status:** ❌ Not implemented

**Missing analysis:**
- Transporter utilization breakdown (% idle vs productive)
- Phase distribution (lift, move, sink, idle)
- Average task duration per transporter
- Station occupancy rates
- Bottleneck identification
- Changeover time statistics

### 3. Batch Flow Analysis
**Status:** ❌ Not implemented

**Missing per-batch metrics:**
- Lead time (start to finish)
- Stage duration comparisons (actual vs min/max)
- CalcTime stretching analysis
- Treatment program performance comparison

### 4. Constraint & Quality Metrics
**Status:** ❌ Not implemented

**Missing validation summary:**
- Conflict detection results
- Near-miss warnings (constraints almost violated)
- Deadhead statistics (empty movements)
- Optimization quality metrics (makespan vs theoretical minimum)
- Schedule tightness/slack analysis

### 5. Input Configuration Documentation
**Status:** ⚠️ Partially covered

**Covered:**
- Stations and treatment programs shown in PDF

**Missing:**
- Transporter physics parameters
- Task areas and operational ranges
- Solver settings (threads, time limits, decomposition mode)
- Environment variables used

### 6. Visual Improvements
**Status:** ⚠️ Partially covered

**Issues:**
- Matrix timeline split across 10 PNGs, but only page 1 included in PDF
- No summary charts (station utilization heatmap, batch flow timeline, transporter paths)
- No comparison visualizations (actual vs theoretical durations)

### 7. Metadata & Traceability
**Status:** ⚠️ Partially covered

**Covered:**
- Folder name on cover page

**Missing:**
- Git commit hash or version tracking
- Unique simulation ID or run number
- Input parameter hash (to detect configuration changes)

---

## Enhancement Roadmap

### Priority 1: Core Reporting Enhancements (High Impact)

#### 1.1 Executive Summary Page
**Goal:** Provide 1-page KPI dashboard at report start

**Implementation:**
- Calculate and display key metrics:
  - Simulation runtime (wall clock)
  - Makespan (production end time)
  - Total batches processed
  - Solver status and solve times (Phase 1 + Phase 2)
  - Objective value and optimization gap
  - Decomposition info (if used)
- Use clear layout with sections and bullet points
- Add simple bar charts for quick visual comparison

**Files to modify:**
- `generate_simulation_report.py`: Add executive summary section

#### 1.2 Performance Metrics Section
**Goal:** Calculate and display utilization, bottlenecks, lead times

**Implementation:**
- Transporter utilization:
  - Parse `transporter_phases.csv` and `transporters_movement.csv`
  - Calculate % time in each phase (idle, lift, move, sink)
  - Generate utilization table and charts
- Station analysis:
  - Parse `cp_sat_station_schedule.csv`
  - Calculate occupancy rates, idle gaps, average batch duration per station
  - Identify bottlenecks (stations with longest queues or highest utilization)
- Batch lead times:
  - Parse `cp_sat_batch_schedule.csv` or `cp_sat_hoist_schedule.csv`
  - Calculate per-batch start-to-finish times
  - Generate histogram or summary table

**New scripts to create:**
- `analyze_transporter_utilization.py`
- `analyze_station_usage.py`
- `analyze_batch_flow.py`

**Files to modify:**
- `generate_simulation_report.py`: Integrate analysis results into PDF

#### 1.3 Complete Timeline Visualization
**Goal:** Include all 10 matrix timeline pages or generate compact multi-page Gantt

**Implementation:**
- Option A: Include all existing PNG pages in PDF
- Option B: Generate single comprehensive Gantt chart with pagination
- Add page numbers and navigation

**Files to modify:**
- `generate_simulation_report.py`: Loop through all timeline PNGs

#### 1.4 Solver Status & Validation Summary
**Goal:** Clear reporting of feasibility, solve time, constraints

**Implementation:**
- Parse solver output from logs or add explicit status file
- Check for conflict CSV files (hoist, station, cross-transporter)
- Display validation results:
  - ✅ No conflicts detected
  - ⚠️ Near-miss warnings (if any)
  - ❌ Conflicts found (with details)
- Include solver configuration used (threads, time limits, decomposition)

**Files to modify:**
- `cp_sat_phase_1.py`, `cp_sat_phase_2.py`: Write solver status to JSON
- `generate_simulation_report.py`: Read and display solver status

---

### Priority 2: Deeper Analysis (Medium Impact)

#### 2.1 Batch-Level Breakdown Table
**Goal:** Detailed table with per-batch metrics

**Columns:**
- Batch ID
- Treatment Program
- Start Time
- End Time
- Lead Time
- Number of Stages
- Total Processing Time
- Total Transfer Time

**Implementation:**
- New script: `analyze_batch_metrics.py`
- Generate CSV and integrate into PDF report

#### 2.2 Station Analysis Section
**Goal:** Comprehensive station usage analysis

**Metrics:**
- Usage frequency (number of batches)
- Total occupancy time
- Average batch duration
- Idle time / gaps between batches
- Changeover time statistics
- Queue length (if applicable)

**Implementation:**
- Extend `analyze_station_usage.py`
- Generate station utilization heatmap (time vs station)
- Add section to PDF report

#### 2.3 Constraint Validation Report
**Goal:** Detailed pass/fail summary with near-miss warnings

**Implementation:**
- Parse validation results from solver
- Check margins on all constraints:
  - Station changeover times (actual vs minimum)
  - Transporter deadhead gaps (actual vs minimum)
  - Cross-transporter collision avoidance
- Flag cases where actual < required + safety_margin
- Generate warnings CSV and integrate into report

**Files to modify:**
- `cp_sat_phase_2.py`: Add detailed validation output
- New script: `analyze_constraints.py`

---

### Priority 3: Polish & Future-Proofing (Lower Priority)

#### 3.1 Interactive Dashboard Export
**Goal:** Export structured JSON for external BI tools

**Implementation:**
- Create summary JSON with all key metrics
- Include links to detailed CSV files
- Enable integration with Power BI, Tableau, or custom dashboards

**New file:**
- `export_dashboard_json.py`

#### 3.2 Historical Comparison Support
**Goal:** Enable comparison across multiple simulation runs

**Implementation:**
- Define unique simulation ID scheme
- Store summary metrics in centralized comparison database or CSV
- Provide scripts to compare runs (future separate tool)

**Note:** This requires backend system integration (out of scope for current phase)

#### 3.3 Full Input Parameter Documentation
**Goal:** Complete dump of all configuration and settings

**Implementation:**
- Document all solver environment variables used
- Include transporter physics, task areas, solver settings in appendix
- Add version/Git commit hash for traceability

**Files to modify:**
- `generate_simulation_report.py`: Add configuration appendix

#### 3.4 Enhanced Visualizations
**Goal:** Add summary charts and comparison visuals

**Ideas:**
- Station utilization heatmap (time vs station)
- Batch flow Sankey diagram
- Transporter movement path visualization
- Actual vs min/max duration comparison charts

**Implementation:**
- Extend visualization scripts
- Integrate into PDF report

---

## Implementation Strategy

### Phase 1: Quick Wins (1-2 weeks)
1. Add executive summary page (1.1)
2. Include all timeline pages in PDF (1.3)
3. Add solver status section (1.4)

### Phase 2: Core Analytics (2-3 weeks)
4. Implement transporter utilization analysis (1.2)
5. Implement station usage analysis (2.2)
6. Add batch-level breakdown (2.1)

### Phase 3: Quality & Depth (2-3 weeks)
7. Implement constraint validation report (2.3)
8. Add enhanced visualizations (3.4)
9. Document full input configuration (3.3)

### Phase 4: Integration & Future (ongoing)
10. Export dashboard JSON (3.1)
11. Historical comparison support (3.2)

---

## Success Criteria

A comprehensive simulation report should enable users to:

1. **Quickly understand** the simulation outcome (feasible? optimal? how long?)
2. **Identify issues** (bottlenecks, constraint violations, inefficiencies)
3. **Make informed decisions** about configuration changes
4. **Compare** different simulation runs (future capability)
5. **Trace** exact inputs and settings used for reproducibility

The enhanced PDF report should be self-contained and suitable for:
- Management presentations
- Technical review
- Archival and compliance
- Knowledge transfer to new team members

---

## Technical Notes

### Data Sources
- `logs/simulation_log.csv`: Timestamped events, errors
- `cp_sat/cp_sat_batch_schedule.csv`: Phase 1 assignments
- `cp_sat/cp_sat_hoist_schedule.csv`: Phase 2 transporter tasks
- `cp_sat/cp_sat_station_schedule.csv`: Station occupancy
- `reports/transporter_phases.csv`: Phase time breakdown
- `logs/movement_diagnostics.csv`: Movement validation
- `logs/transporters_movement.csv`: Detailed movement phases

### Tools & Libraries
- **PDF generation**: fpdf2 (already in use)
- **Data analysis**: pandas, numpy
- **Visualization**: matplotlib, seaborn (for heatmaps)
- **Optional**: plotly (for interactive charts), jinja2 (for HTML reports)

### Output Structure (Enhanced)
```
output/
  <timestamp>/
    initialization/       # Input data snapshot
    cp_sat/              # Solver outputs
    logs/                # Execution logs
    reports/             # Reports and visualizations
      simulation_report_<timestamp>.pdf   # Main comprehensive report
      executive_summary.json              # Machine-readable summary (future)
      transporter_utilization.csv         # Detailed metrics (future)
      station_analysis.csv                # Detailed metrics (future)
      batch_metrics.csv                   # Detailed metrics (future)
      *.png                               # Visualization images
```

---

## Maintenance & Updates

This plan should be reviewed and updated:
- After each major implementation milestone
- When new analysis requirements emerge
- When integration with backend system progresses
- Based on user feedback and actual usage patterns

**Document version:** 1.0  
**Last updated:** November 10, 2025  
**Next review:** After Phase 1 completion
